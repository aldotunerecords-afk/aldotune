<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ubah PIN Transaksi - Aldotune</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { aldo: { black: '#0a0a0a', hover: '#f4f4f5', border: '#e4e4e7' } },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #ffffff; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 4px; }
        
        .input-field {
            width: 100%; border: 1px solid #e5e7eb; border-radius: 0.75rem;
            padding: 14px 16px; font-weight: 600; font-size: 0.875rem;
            transition: all 0.2s; outline: none;
        }
        .input-field:focus { border-color: #000; box-shadow: 0 0 0 4px rgba(0,0,0,0.05); }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-black bg-white">

    <div id="toastContainer" class="fixed top-0 left-0 w-full z-[100] flex justify-center pointer-events-none p-4">
        <div id="toast" class="bg-black text-white px-6 py-4 rounded-full shadow-2xl flex items-center gap-3 transform -translate-y-24 opacity-0 transition-all duration-300 pointer-events-auto">
            <i id="toastIcon" data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            <span id="toastMessage" class="font-medium text-sm">Berhasil</span>
        </div>
    </div>

    <div id="appLoader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-10 h-10 border-4 border-gray-100 rounded-full relative">
            <div class="w-10 h-10 border-4 border-black rounded-full border-t-transparent animate-spin absolute top-0 left-0"></div>
        </div>
        <p class="mt-4 text-xs font-bold text-gray-400 tracking-widest uppercase">Memuat...</p>
    </div>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden transition-opacity duration-300 opacity-0"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-white border-r border-aldo-border transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col h-full">
        <div class="h-20 flex items-center px-8 border-b border-gray-100 shrink-0 justify-between">
            <h1 class="text-2xl font-extrabold tracking-tighter">aldotune.</h1>
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-black"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex-1 overflow-y-auto sidebar-scroll py-6 px-4 space-y-8">
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Menu Utama</p>
                <nav class="space-y-1">
                    <a href="beranda.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="layout-grid" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Beranda</span>
                    </a>
                    <a href="musisi.html" id="adminMenuLink" class="hidden flex items-center gap-3 px-4 py-3 text-red-600 bg-red-50 hover:bg-red-100 rounded-xl transition-all group">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span class="text-sm font-bold">Data Musisi</span>
                    </a>
                    <a href="katalog.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="disc-3" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Katalog Musik</span>
                    </a>
                    <a href="analitik.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Analitik</span>
                    </a>
                </nav>
            </div>
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Promosi & Profil</p>
                <nav class="space-y-1">
                    <a href="verifikasi.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-[#1DB954] hover:bg-green-50 rounded-xl transition-all group">
                        <i data-lucide="badge-check" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Verifikasi Spotify</span>
                    </a>
                    <a href="playlist.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="list-music" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Playlist Spotify</span>
                    </a>
                    <a href="promosi.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="megaphone" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Promosi</span>
                    </a>
                </nav>
            </div>
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Manajemen Aset</p>
                <nav class="space-y-1">
                    <a href="publishing.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="globe" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Publishing</span>
                    </a>
                    <a href="lirik.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="mic-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Lirik & Sync</span>
                    </a>
                    <a href="hakcipta.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="shield-check" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Hak Cipta / Legal</span>
                    </a>
                </nav>
            </div>
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Keuangan</p>
                <nav class="space-y-1">
                    <a href="dompet.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="wallet" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Dompet & Royalti</span>
                    </a>
                </nav>
            </div>
        </div>
    </aside>

    <div id="mainContent" class="flex-1 flex flex-col lg:pl-64 h-full relative">
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-aldo-border flex items-center justify-between px-6 sticky top-0 z-20">
            <button onclick="toggleSidebar()" class="p-2 -ml-2 mr-2 text-black hover:bg-gray-100 rounded-lg"><i data-lucide="menu" class="w-6 h-6"></i></button>
            <div class="flex-1"></div>
            <div class="flex items-center gap-3">
                <a href="upload.html" class="bg-black hover:bg-gray-800 text-white text-sm font-bold px-5 py-2.5 rounded-full flex items-center gap-2 transition-all shadow-lg shadow-black/20">
                    <i data-lucide="upload-cloud" class="w-4 h-4"></i><span class="hidden sm:inline">Rilis Baru</span>
                </a>
                <div class="h-8 w-[1px] bg-gray-200 mx-1"></div>
                <div class="relative">
                    <button id="profileBtn" onclick="toggleProfileMenu()" class="flex items-center gap-2 pl-2 pr-1 py-1 rounded-full hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-all group select-none">
                        <div class="text-right hidden md:block"><p id="navUserName" class="text-xs font-bold text-black leading-none skeleton h-3 w-16 rounded mb-1"></p><p class="text-[10px] text-gray-400 font-medium">Akun Saya</p></div>
                        <img id="navUserImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-9 h-9 rounded-full bg-gray-200 object-cover border border-gray-100 group-hover:scale-105 transition-transform">
                        <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                    </button>
                    <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-2xl shadow-xl border border-gray-100 p-2 z-50">
                        <a href="profil.html" class="flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-gray-600 hover:text-black hover:bg-gray-50 rounded-xl transition-colors"><i data-lucide="user" class="w-4 h-4"></i> Lihat Profil</a>
                        <a href="pin-transaksi.html" class="flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-black bg-gray-50 rounded-xl transition-colors"><i data-lucide="key" class="w-4 h-4"></i> Ubah PIN Transaksi</a>
                        <a href="reset.html" class="flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-gray-600 hover:text-black hover:bg-gray-50 rounded-xl transition-colors"><i data-lucide="lock" class="w-4 h-4"></i> Ubah PIN Akses</a>
                        <div class="h-[1px] bg-gray-100 my-1"></div>
                        <button onclick="openLogoutModal()" class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-red-600 hover:bg-red-50 rounded-xl text-left"><i data-lucide="log-out" class="w-4 h-4"></i> Keluar</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 md:p-10 bg-white">
            <div class="max-w-md mx-auto space-y-8 opacity-0 animate-fade-in">
                
                <div class="flex items-center gap-4">
                    <a href="profil.html" class="p-2 rounded-full hover:bg-gray-100 transition-colors"><i data-lucide="arrow-left" class="w-6 h-6 text-black"></i></a>
                    <div><h1 class="text-2xl font-extrabold text-black">PIN Transaksi</h1><p class="text-sm text-gray-500">Amankan aktivitas finansial Anda.</p></div>
                </div>

                <div id="step1" class="space-y-6">
                    <div class="bg-gray-50 border border-gray-200 p-4 rounded-2xl flex gap-3 items-start">
                        <i data-lucide="shield-alert" class="w-5 h-5 text-black shrink-0 mt-0.5"></i>
                        <p class="text-sm text-gray-600">Demi keamanan, silakan verifikasi identitas Anda (NIK & Tanggal Lahir) sebelum mengubah PIN.</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">NIK (KTP)</label>
                            <input type="number" id="verifyNik" class="input-field font-mono" placeholder="35xxxxxxxxxxxxxx">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Tanggal Lahir</label>
                            <input type="date" id="verifyDob" class="input-field">
                        </div>
                    </div>

                    <button onclick="verifyIdentity()" id="verifyBtn" class="w-full h-14 bg-black text-white font-bold rounded-full hover:bg-gray-800 transition-all flex items-center justify-center gap-2">
                        Verifikasi Data
                    </button>
                </div>

                <div id="step2" class="hidden space-y-6 animate-slide-up">
                    <div class="text-center mb-6">
                        <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-2"><i data-lucide="check" class="w-6 h-6"></i></div>
                        <h3 class="text-lg font-bold text-black">Identitas Terverifikasi</h3>
                        <p class="text-sm text-gray-500">Silakan buat PIN Transaksi baru.</p>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">PIN Transaksi Baru (6 Digit)</label>
                        <div class="relative">
                            <input type="password" id="newPin" maxlength="6" inputmode="numeric" pattern="\d{6}" class="input-field text-center text-2xl tracking-[0.5em]" placeholder="••••••">
                            <button onclick="togglePinVisibility()" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-black"><i id="eyeIcon" data-lucide="eye" class="w-5 h-5"></i></button>
                        </div>
                    </div>

                    <button onclick="saveNewPin()" id="saveBtn" class="w-full h-14 bg-black text-white font-bold rounded-full hover:bg-gray-800 transition-all">
                        Simpan PIN Baru
                    </button>
                </div>

            </div>
        </main>
    </div>

    <div id="logoutModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden opacity-0 flex items-center justify-center p-4 transition-all duration-300">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform scale-95 transition-all">
            <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4 text-red-600"><i data-lucide="log-out" class="w-6 h-6"></i></div>
            <div class="text-center mb-6"><h3 class="text-xl font-bold text-black mb-1">Konfirmasi</h3><p class="text-gray-500 text-sm">Pilih tindakan untuk akun Anda.</p></div>
            <div class="space-y-3">
                <button onclick="handleSoftExit()" class="w-full py-3 rounded-xl font-bold text-black bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">Keluar <span class="text-xs font-medium text-gray-500">(Ke Halaman Login)</span></button>
                <button onclick="handleHardLogout()" class="w-full py-3 rounded-xl font-bold text-white bg-black hover:bg-gray-800 transition-colors">Akhiri Sesi (Logout)</button>
                <button onclick="closeLogoutModal()" class="w-full py-2 text-sm font-bold text-gray-400 hover:text-black mt-2">Batal</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, update, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqOzMh1oUnzxohMET1SsA8ZpnPm7rgjrY",
            authDomain: "aldotune-records.firebaseapp.com",
            databaseURL: "https://aldotune-records-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aldotune-records",
            storageBucket: "aldotune-records.firebasestorage.app",
            messagingSenderId: "311200667476",
            appId: "1:311200667476:web:7805289d9d01c981ef5ac1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const els = {
            appLoader: document.getElementById('appLoader'),
            navUserName: document.getElementById('navUserName'),
            navUserImg: document.getElementById('navUserImg'),
            adminMenu: document.getElementById('adminMenuLink'),
            profileMenu: document.getElementById('profileMenu'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toastMessage'),
            // Form
            step1: document.getElementById('step1'),
            step2: document.getElementById('step2'),
            verifyNik: document.getElementById('verifyNik'),
            verifyDob: document.getElementById('verifyDob'),
            verifyBtn: document.getElementById('verifyBtn'),
            newPin: document.getElementById('newPin'),
            saveBtn: document.getElementById('saveBtn')
        };

        let activeUid = null;
        let userData = null;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                activeUid = user.uid;
                loadUserData(user);
            } else {
                window.location.replace("login.html");
            }
        });

        function loadUserData(user) {
            const uid = user.uid;
            const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${user.email.substring(0,2)}&background=random`;
            els.navUserImg.src = avatarUrl;

            get(child(ref(db), `users/${uid}`)).then((snapshot) => {
                userData = snapshot.val();
                
                if (userData && userData.j === "a") els.adminMenu.classList.remove('hidden');
                else els.adminMenu.classList.add('hidden');

                const name = userData?.fullName || user.displayName || "Artis";
                els.navUserName.innerText = name.split(' ')[0];

                setTimeout(() => els.appLoader.classList.add('opacity-0', 'pointer-events-none'), 500);
            }).catch(e => console.error(e));
        }

        // VERIFY IDENTITY
        window.verifyIdentity = () => {
            const inputNik = els.verifyNik.value;
            const inputDob = els.verifyDob.value;

            if(!inputNik || !inputDob) return showToast("Mohon lengkapi data", true);
            
            els.verifyBtn.disabled = true;
            els.verifyBtn.innerText = "Memeriksa...";

            // Compare with stored data
            if (String(userData.nik) === String(inputNik) && String(userData.birthDate) === String(inputDob)) {
                setTimeout(() => {
                    els.step1.classList.add('hidden');
                    els.step2.classList.remove('hidden');
                }, 1000);
            } else {
                setTimeout(() => {
                    showToast("NIK atau Tanggal Lahir salah!", true);
                    els.verifyBtn.disabled = false;
                    els.verifyBtn.innerText = "Verifikasi Data";
                }, 1000);
            }
        };

        // SAVE NEW PIN
        window.saveNewPin = () => {
            const pin = els.newPin.value;
            if(pin.length !== 6) return showToast("PIN harus 6 digit angka", true);

            els.saveBtn.disabled = true;
            els.saveBtn.innerText = "Menyimpan...";

            update(ref(db, `users/${activeUid}`), {
                pin: pin,
                updatedAt: Date.now()
            }).then(() => {
                showToast("PIN Berhasil Diubah!");
                setTimeout(() => window.location.href = "profil.html", 1500);
            }).catch(e => {
                showToast("Gagal menyimpan", true);
                els.saveBtn.disabled = false;
                els.saveBtn.innerText = "Simpan PIN Baru";
            });
        };

        // UI HELPERS
        function showToast(msg, isError = false) {
            els.toastMsg.innerText = msg;
            document.getElementById('toastIcon').classList.toggle('text-green-400', !isError);
            document.getElementById('toastIcon').classList.toggle('text-red-400', isError);
            document.getElementById('toastIcon').setAttribute('data-lucide', isError ? 'alert-circle' : 'check-circle');
            lucide.createIcons();

            els.toast.classList.remove('-translate-y-24', 'opacity-0');
            setTimeout(() => els.toast.classList.add('-translate-y-24', 'opacity-0'), 3000);
        }

        window.togglePinVisibility = () => {
            const type = els.newPin.type === "password" ? "text" : "password";
            els.newPin.type = type;
            document.getElementById('eyeIcon').setAttribute('data-lucide', type === "password" ? "eye" : "eye-off");
            lucide.createIcons();
        };

        // Standard Toggles
        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const mainContent = document.getElementById('mainContent');
            if (window.innerWidth < 1024) {
                if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden', 'opacity-0'); }
                else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300); }
            } else {
                if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); mainContent.classList.add('lg:pl-64'); mainContent.classList.remove('lg:pl-0'); }
                else { sidebar.classList.add('-translate-x-full'); mainContent.classList.remove('lg:pl-64'); mainContent.classList.add('lg:pl-0'); }
            }
        };

        window.toggleProfileMenu = () => els.profileMenu.classList.toggle('hidden');
        document.addEventListener('click', (e) => { if (!document.getElementById('profileBtn').contains(e.target) && !els.profileMenu.contains(e.target)) els.profileMenu.classList.add('hidden'); });
        window.openLogoutModal = () => { els.profileMenu.classList.add('hidden'); document.getElementById('logoutModal').classList.remove('hidden', 'opacity-0'); };
        window.closeLogoutModal = () => { const m = document.getElementById('logoutModal'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); };
        window.handleSoftExit = () => window.location.href = "login.html";
        window.handleHardLogout = () => signOut(auth).then(() => window.location.replace("login.html"));

        lucide.createIcons();
    </script>
</body>
</html>