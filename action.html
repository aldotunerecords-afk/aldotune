<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Action Center - Aldotune</title>
  <style>
    /* Global Styles Aldotune */
    * { box-sizing: border-box; }
    html, body { 
      margin: 0; padding: 0; width: 100%; height: 100%; 
      font-family: Arial, sans-serif; 
      background: linear-gradient(135deg, #ffffff, #f3f8ff); 
      display: flex; align-items: center; justify-content: center; 
      overflow: hidden;
    }
    .container { width: 100%; max-width: 400px; padding: 20px; text-align: center; }
    .acss-logo { width: 100px; margin-bottom: 20px; cursor: pointer; }
    
    .card { 
      background: white; padding: 30px; 
      border-radius: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.05); 
      animation: fadeIn 0.4s ease; text-align: left; 
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    h2 { font-size: 20px; color: #1f3a5f; margin-bottom: 10px; text-align: center; margin-top: 0; }
    p { font-size: 13px; color: #64748b; text-align: center; margin-bottom: 20px; line-height: 1.5; }
    label { display: block; font-size: 13px; font-weight: 600; color: #1f3a5f; margin-bottom: 5px; margin-top: 15px; }
    
    .password-wrapper { position: relative; width: 100%; }
    input { 
      width: 100%; padding: 12px; padding-right: 45px; border-radius: 10px; 
      border: 1px solid #ddd; font-size: 14px; outline: none; transition: 0.3s; 
      letter-spacing: 2px;
    }
    input:focus { border-color: #1f3a5f; }
    
    .toggle-password {
      position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
      cursor: pointer; color: #64748b; font-size: 18px; user-select: none;
    }
    
    .status-msg { 
      margin-top: 20px; padding: 15px; border-radius: 12px; 
      font-size: 13px; text-align: center; line-height: 1.5; display: none;
    }
    .error { background: #fff1f2; color: #e11d48; border: 1px solid #ffe4e6; display: block; }
    .success { background: #f0f7ff; color: #1f3a5f; border: 1px solid #dbeafe; display: block; }

    .actions { margin-top: 25px; display: flex; flex-direction: column; gap: 10px; }
    .btn { width: 100%; padding: 14px; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; border: none; transition: 0.3s; text-decoration: none; text-align: center; }
    .btn-primary { background: #1f3a5f; color: white; }
    .btn-primary:disabled { opacity: 0.6; }
    .btn-secondary { background: #f1f5f9; color: #475569; }

    footer { margin-top: 25px; font-size: 11px; color: #94a3b8; text-align: center; }
  </style>
</head>
<body>

  <div class="container">
    <img src="acss.png" alt="Aldotune Logo" class="acss-logo" onclick="location.href='login.html'">

    <div class="card">
      
      <div id="resetArea" style="display: none;">
        <h2>Kode Akses Baru</h2>
        <p>Wajib 6 karakter. Contoh: <strong>Amir21</strong></p>
        
        <label>Masukkan Kode Akses Baru</label>
        <div class="password-wrapper">
          <input type="password" id="newPassword" placeholder="Amir21" maxlength="6">
          <span class="toggle-password" id="eyeIcon">üëÅÔ∏è</span>
        </div>

        <div class="actions">
          <button class="btn btn-primary" id="btnUpdate">Simpan Kode Akses</button>
        </div>
      </div>

      <div id="verifyArea" style="display: none;">
        <h2>Verifikasi Email</h2>
        <p id="verifyStatus" style="text-align: center; font-style: italic; color: #64748b;">Memproses validasi akun...</p>
      </div>

      <div id="messageBox" class="status-msg"></div>

      <div class="actions">
        <a href="login.html" class="btn btn-secondary">Kembali ke Login</a>
      </div>
    </div>
    
    <footer>¬© 2026 ALDOTUNE CREATIVE STUDIO</footer>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, confirmPasswordReset, verifyPasswordResetCode, applyActionCode, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAqOzMh1oUnzxohMET1SsA8ZpnPm7rgjrY",
      authDomain: "aldotune-records.firebaseapp.com",
      projectId: "aldotune-records",
      storageBucket: "aldotune-records.firebasestorage.app",
      messagingSenderId: "311200667476",
      appId: "1:311200667476:web:7805289d9d01c981ef5ac1"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    const urlParams = new URLSearchParams(window.location.search);
    const mode = urlParams.get('mode');
    const actionCode = urlParams.get('oobCode');

    const msgBox = document.getElementById("messageBox");
    const resetArea = document.getElementById("resetArea");
    const verifyArea = document.getElementById("verifyArea");
    const passInput = document.getElementById("newPassword");
    const eyeIcon = document.getElementById("eyeIcon");

    // FITUR LIHAT KODE
    eyeIcon.onclick = () => {
      if (passInput.type === "password") {
        passInput.type = "text";
        eyeIcon.innerText = "üôà";
      } else {
        passInput.type = "password";
        eyeIcon.innerText = "üëÅÔ∏è";
      }
    };

    async function clearAllSessions() {
      try {
        await signOut(auth);
        localStorage.clear();
        sessionStorage.clear();
        document.cookie.split(";").forEach((c) => {
          document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
        });
      } catch (e) { console.error(e); }
    }

    if (!mode || !actionCode) {
      showMessage("‚ùå <strong>Akses Ditolak:</strong> Link tidak valid.", "error");
    } else {
      
      if (mode === 'resetPassword') {
        verifyPasswordResetCode(auth, actionCode).then(() => {
          resetArea.style.display = "block";
        }).catch(() => {
          showMessage("‚ùå <strong>Link Kadaluarsa:</strong> Silakan minta link baru.", "error");
        });

        document.getElementById("btnUpdate").onclick = async () => {
          const newPass = passInput.value.trim();
          const btn = document.getElementById("btnUpdate");
          
          // Validasi ketat: Harus tepat 6 karakter
          if (newPass.length !== 6) {
            alert("Kode akses harus tepat 6 karakter!");
            return;
          }

          btn.disabled = true; btn.innerText = "Menyimpan...";
          try {
            await confirmPasswordReset(auth, actionCode, newPass);
            await clearAllSessions();
            resetArea.style.display = "none";
            showMessage("‚úÖ <strong>Berhasil!</strong> Kode akses diperbarui. Silakan login kembali.", "success");
          } catch (err) {
            btn.disabled = false; btn.innerText = "Simpan Kode Akses";
            showMessage("‚ùå <strong>Gagal:</strong> Terjadi kesalahan sistem.", "error");
          }
        };
      }

      else if (mode === 'verifyEmail') {
        verifyArea.style.display = "block";
        applyActionCode(auth, actionCode).then(async () => {
          await clearAllSessions();
          verifyArea.style.display = "none";
          showMessage("‚úÖ <strong>Email Terverifikasi!</strong> Silakan login kembali.", "success");
        }).catch(() => {
          verifyArea.style.display = "none";
          showMessage("‚ùå <strong>Gagal:</strong> Link tidak valid.", "error");
        });
      }
    }

    function showMessage(txt, type) {
      msgBox.innerHTML = txt;
      msgBox.className = `status-msg ${type}`;
      msgBox.style.display = "block";
    }
  </script>
</body>
</html>
