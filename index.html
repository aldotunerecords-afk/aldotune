<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masuk - Aldotune Creative Studio</title>

    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text x='50%' y='50%' dy='.35em' text-anchor='middle' font-size='65' font-family='Arial, sans-serif' font-weight='bold' fill='%23000000'>a</text></svg>">
    
    <style id="main-style" media="not all">
        /* --- RESET & STYLE --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', 'Open Sans', Helvetica, Arial, sans-serif; }
        body { background-color: #ffffff; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; color: #333; padding-top: 60px; }
        .login-container { width: 100%; max-width: 480px; padding: 20px; text-align: center; animation: fadeIn 0.8s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        
        .logo-wrapper { margin-bottom: 50px; display: flex; justify-content: center; }
        .logo-img { max-width: 280px; height: auto; display: block; }
        
        .form-row { display: flex; align-items: center; margin-bottom: 25px; height: 55px; }
        .icon-wrapper { width: 40px; display: flex; justify-content: center; align-items: center; margin-right: 15px; }
        .icon-wrapper svg { width: 22px; height: 22px; fill: #bfbfbf; }
        
        /* Input Style */
        .custom-input { width: 100%; height: 100%; background-color: #f2f2f2; border: none; padding: 0 20px; font-size: 16px; color: #333; outline: none; transition: 0.2s; border-radius: 4px; }
        .custom-input::placeholder { color: #b0b0b0; font-size: 15px; }
        .custom-input:focus { background-color: #e8e8e8; box-shadow: inset 4px 0 0 #0056b3; }
        
        /* Style Input Terkunci */
        .custom-input:disabled {
            background-color: #e0e0e0;
            color: #666;
            cursor: not-allowed;
            border-bottom: 2px solid #999;
        }

        .btn-wrapper { margin-top: 50px; margin-bottom: 30px; }
        .btn-login { background-color: #bfbfbf; color: white; border: none; padding: 15px 80px; border-radius: 50px; font-size: 14px; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; cursor: not-allowed; transition: all 0.3s ease; }
        .btn-login.active { background-color: #0056b3; cursor: pointer; box-shadow: 0 5px 15px rgba(0, 86, 179, 0.2); }
        .btn-login.active:hover { background-color: #004494; transform: translateY(-2px); }
        
        /* Footer Links */
        .footer-links { margin-top: 10px; display: flex; flex-direction: column; gap: 15px; align-items: center; }
        .forgot-link { font-size: 14px; color: #5caad9; text-decoration: none; cursor: pointer; }
        .forgot-link:hover { color: #4a8ab3; text-decoration: underline; }
        
        .register-text { font-size: 14px; color: #888; display: block; }
        .register-link { color: #333; text-decoration: none; font-weight: bold; }
        .register-link:hover { color: #0056b3; text-decoration: underline; }

        /* 2. TOMBOL KELUAR (MERAH SOLID) */
        .logout-link {
            margin-top: 10px;
            font-size: 14px;
            font-weight: bold;
            color: white !important; /* Teks Putih */
            background-color: #d9534f; /* Latar Merah Solid */
            text-decoration: none;
            cursor: pointer;
            border: none; /* Hapus border */
            padding: 12px 30px; /* Padding lebih besar seperti tombol */
            border-radius: 50px; /* Sudut bulat */
            transition: 0.2s;
            display: none; /* Sembunyi default */
            box-shadow: 0 4px 10px rgba(217, 83, 79, 0.3); /* Bayangan merah halus */
        }
        .logout-link:hover {
            background-color: #c9302c; /* Merah lebih gelap saat hover */
            transform: translateY(-2px);
        }

    </style>

    <style>
        #boot-terminal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #ffffff; color: #333333; font-family: 'Consolas', 'Courier New', monospace; font-size: 13px; padding: 20px; z-index: 9999; display: block; overflow: hidden; }
        .log-line { display: block; margin-bottom: 4px; white-space: pre-wrap; }
        
        /* ANTI SPAM */
        body.is-loading { cursor: wait !important; }
        body.is-loading * { pointer-events: none !important; cursor: wait !important; }
    </style>
</head>
<body class="is-loading">

    <div id="boot-terminal"></div>

    <div class="login-container">
        <div class="logo-wrapper">
            <img src="acss.png" alt="Aldotune Logo" class="logo-img" id="mainLogo" style="display: none;">
        </div>

        <form id="loginForm">
            <div class="form-row">
                <div class="icon-wrapper" id="iconEmail" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/></svg>
                </div>
                <input type="email" id="emailInput" class="custom-input" placeholder="Email Perusahaan" readonly="true" onfocus="this.removeAttribute('readonly');" autocomplete="off">
            </div>

            <div class="form-row">
                <div class="icon-wrapper" id="iconPin" style="display: none;">
                    <svg viewBox="0 0 24 24"><path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zm-6 9c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm3.1-9H8.9V6c0-1.71 1.39-3.1 3.1-3.1 1.71 0 3.1 1.39 3.1 3.1v2z"/></svg>
                </div>
                <input type="password" id="pinInput" class="custom-input" placeholder="PIN (6 Digit)" maxlength="6" inputmode="numeric" pattern="\d{6}" readonly="true" onfocus="this.removeAttribute('readonly');" autocomplete="off">
            </div>

            <div class="btn-wrapper">
                <button type="submit" id="btnSubmit" class="btn-login" disabled>MASUK</button>
            </div>
        </form>

        <div class="footer-links">
            <a href="reset.html" class="forgot-link"><b>Lupa PIN?</b></a>
            
            <button id="btnLogout" class="logout-link">Keluar / Ganti Akun</button>

            <span class="register-text" id="registerSection">
                Belum punya akun? <a href="daftar.html" class="register-link">Daftar</a>
            </span>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqOzMh1oUnzxohMET1SsA8ZpnPm7rgjrY",
            authDomain: "aldotune-records.firebaseapp.com",
            databaseURL: "https://aldotune-records-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aldotune-records",
            storageBucket: "aldotune-records.firebasestorage.app",
            messagingSenderId: "311200667476",
            appId: "1:311200667476:web:7805289d9d01c981ef5ac1",
            measurementId: "G-GQ3Y2GKWG1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // --- TERMINAL ---
        const terminal = document.getElementById('boot-terminal');
        const logs = [
            "> System Init...",
            "> Connecting to: aldotune-records.firebaseapp.com",
            "> [Config] API_KEY: AIzaSy...rgjrY detected.",
            "> [Auth] Service initialized.",
            "> [Secure] Enforcing HTTPS connection...",
            "> [Session] Checking local cache...",
            "> Ready."
        ];

        let lineIndex = 0;
        const logInterval = setInterval(() => {
            if(lineIndex < logs.length) {
                const p = document.createElement('span');
                p.className = 'log-line';
                p.innerText = logs[lineIndex];
                terminal.appendChild(p);
                lineIndex++;
            } else {
                clearInterval(logInterval);
            }
        }, 80);

        // --- UI ELEMENTS ---
        const emailInput = document.getElementById('emailInput');
        const pinInput = document.getElementById('pinInput');
        const btnSubmit = document.getElementById('btnSubmit');
        const btnLogout = document.getElementById('btnLogout');
        const registerSection = document.getElementById('registerSection');

        // SETELAH 1.2 DETIK
        setTimeout(() => {
            document.body.classList.remove('is-loading');

            terminal.style.display = 'none';
            document.getElementById('mainLogo').style.display = 'block';
            document.getElementById('iconEmail').style.display = 'flex';
            document.getElementById('iconPin').style.display = 'flex';
            document.getElementById('main-style').setAttribute('media', 'all');

            if (window.location.hash) window.history.replaceState(null, null, ' ');
            const fakePath = "/aldotune.onmicrosoft.com/oauth2/v2.0/authorize";
            const csrf = Math.random().toString(36).substring(2);
            window.history.replaceState(null, null, "#" + fakePath + "?csrf=" + csrf);

            // --- LOGIKA SESI & TOMBOL DAFTAR ---
            const savedEmail = localStorage.getItem('aldotune_email');
            if (savedEmail) {
                // KONDISI: SUDAH PERNAH LOGIN
                emailInput.value = savedEmail;
                emailInput.disabled = true; // Kunci Email
                
                btnLogout.style.display = 'inline-block'; // Tampilkan Tombol Keluar
                registerSection.style.display = 'none';   // SEMBUNYIKAN TOMBOL DAFTAR
                
                pinInput.focus(); 
                checkValidity(); 
            } else {
                // KONDISI: PENGGUNA BARU / SUDAH LOGOUT
                btnLogout.style.display = 'none';       // Sembunyikan Tombol Keluar
                registerSection.style.display = 'block'; // TAMPILKAN TOMBOL DAFTAR
            }

        }, 1200);

        // --- VALIDASI ---
        emailInput.addEventListener('input', checkValidity);
        pinInput.addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '');
            checkValidity();
        });

        function checkValidity() {
            const emailVal = emailInput.value.trim();
            const pinVal = pinInput.value.trim();
            if (emailVal.length > 0 && pinVal.length === 6) {
                btnSubmit.removeAttribute('disabled');
                btnSubmit.classList.add('active');
            } else {
                btnSubmit.setAttribute('disabled', 'true');
                btnSubmit.classList.remove('active');
            }
        }

        // --- LOGIN ---
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            document.body.classList.add('is-loading');

            const email = emailInput.value;
            const pin = pinInput.value;
            btnSubmit.innerText = "MEMVERIFIKASI...";

            signInWithEmailAndPassword(auth, email, pin)
                .then((userCredential) => {
                    const user = userCredential.user;
                    localStorage.setItem('aldotune_email', email); // Simpan Sesi
                    user.getIdToken().then((token) => {
                        window.location.href = `rumah.html?token=${token}`;
                    });
                })
                .catch((error) => {
                    document.body.classList.remove('is-loading');
                    btnSubmit.innerText = "MASUK";
                    
                    let errorMsg = "Terjadi kesalahan sistem.";
                    if (error.code === 'auth/wrong-password') errorMsg = "PIN Salah!";
                    else if (error.code === 'auth/user-not-found') errorMsg = "Email tidak terdaftar.";
                    else if (error.code === 'auth/invalid-email') errorMsg = "Email tidak valid.";
                    else if (error.code === 'auth/too-many-requests') errorMsg = "Terlalu banyak percobaan. Coba lagi nanti.";
                    
                    alert(errorMsg); 
                });
        });

        // --- LOGOUT ---
        btnLogout.addEventListener('click', (e) => {
            e.preventDefault();
            if (confirm("Yakin ingin keluar dan menghapus sesi?")) {
                document.body.classList.add('is-loading');
                btnLogout.innerText = "Membersihkan...";

                signOut(auth).then(() => {
                    localStorage.removeItem('aldotune_email');
                    localStorage.clear();
                    sessionStorage.clear();
                    document.cookie.split(";").forEach((c) => {
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
                    });
                    window.location.reload();
                }).catch((error) => {
                    alert("Gagal: " + error.message);
                    document.body.classList.remove('is-loading');
                });
            }
        });

    </script>
</body>
</html>