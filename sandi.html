<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pengaturan > Kata Sandi - Aldotune</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text x='50%' y='50%' dy='.35em' text-anchor='middle' font-size='65' font-family='Arial, sans-serif' font-weight='bold' fill='%23000000'>a</text></svg>">

    <style>
        /* --- 1. GLOBAL RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        body { background-color: #f6f6f6; display: flex; flex-direction: column; min-height: 100vh; color: #333; }
        a { text-decoration: none; color: inherit; }

        /* --- 2. HEADER --- */
        .top-header {
            height: 64px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }

        .btn-back {
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px; border-radius: 50%;
            transition: background 0.2s; color: #555;
        }
        .btn-back:hover { background-color: #f0f0f0; }
        .btn-back svg { width: 24px; height: 24px; fill: currentColor; }

        .page-title { font-size: 18px; font-weight: 600; color: #222; }

        .user-profile { display: flex; align-items: center; text-align: right; gap: 12px; cursor: pointer; }
        .user-details h4 { font-size: 13px; font-weight: 600; color: #333; margin: 0; text-transform: capitalize; }
        .avatar-icon { width: 34px; height: 34px; fill: #999; flex-shrink: 0; }

        .logout-menu { 
            position: absolute; top: 60px; right: 20px; background: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; 
            overflow: hidden; display: none; z-index: 101; min-width: 200px; 
            border: 1px solid #eee;
        }
        .dropdown-item { display: flex; align-items: center; width: 100%; padding: 12px 20px; background: transparent; border: none; text-align: left; cursor: pointer; color: #555; font-size: 14px; transition: 0.2s; }
        .dropdown-item:hover { background-color: #f9f9f9; color: #000; }
        .dropdown-item svg { width: 18px; height: 18px; margin-right: 12px; fill: #777; }
        .dropdown-divider { height: 1px; background-color: #eee; margin: 0; }

        /* --- 3. KONTEN --- */
        .main-wrapper { flex-grow: 1; width: 100%; max-width: 800px; margin: 0 auto; padding: 0; }

        .breadcrumb-container { padding: 25px 30px; font-size: 14px; color: #777; }
        .breadcrumb-container b { color: #333; }
        .chevron { margin: 0 8px; font-size: 12px; color: #ccc; }

        .settings-container {
            background-color: white;
            width: 100%;
            padding: 30px 35px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            min-height: 400px;
            margin-bottom: 50px;
        }

        .section-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 20px; border-bottom: 1px solid #f0f0f0; padding-bottom: 10px; }

        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px; }
        .form-input {
            width: 100%; padding: 12px 15px; border: 1px solid #ddd;
            border-radius: 6px; font-size: 14px; color: #333; transition: 0.2s;
        }
        .form-input:focus { border-color: #1890ff; outline: none; box-shadow: 0 0 0 3px rgba(24, 144, 255, 0.1); }
        .form-input:disabled { background-color: #f9f9f9; cursor: not-allowed; }

        .btn-primary {
            background-color: #1890ff; color: white; border: none;
            padding: 12px 25px; border-radius: 6px; font-weight: 600; font-size: 14px;
            cursor: pointer; transition: 0.2s; width: 100%;
        }
        .btn-primary:hover { background-color: #096dd9; }
        .btn-primary:disabled { background-color: #ccc; cursor: not-allowed; }

        /* Alert Messages */
        .alert-box { padding: 12px 15px; border-radius: 6px; font-size: 13px; margin-bottom: 20px; display: none; }
        .alert-error { background-color: #fff1f0; border: 1px solid #ffa39e; color: #cf1322; }
        .alert-success { background-color: #f6ffed; border: 1px solid #b7eb8f; color: #389e0d; }

        #step2-change-pin { display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        @media (max-width: 768px) {
            .top-header { padding: 0 15px; }
            .breadcrumb-container { padding: 20px; }
            .settings-container { padding: 20px; border-radius: 0; }
            .user-details { display: none; }
        }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="header-left">
            <a href="rumah.html" class="btn-back">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </a>
            <div class="page-title">Kata Sandi</div>
        </div>

        <div class="user-profile" id="userMenuBtn">
            <div class="user-details">
                <h4 id="displayName">Memuat...</h4>
            </div>
            <svg class="avatar-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        </div>

        <div class="logout-menu" id="logoutMenu">
            <a href="profil.html" class="dropdown-item">Profil</a>
            <a href="sandi.html" class="dropdown-item">Kata Sandi</a>
            <a href="layanan.html" class="dropdown-item">Layanan tambahan</a>
            <div class="dropdown-divider"></div>
            <button id="btnLogout" class="dropdown-item" style="color: #d93025;">Keluar</button>
        </div>
    </header>

    <main class="main-wrapper">
        <div class="breadcrumb-container">
            Pengaturan <span class="chevron">›</span> <b>Kata Sandi (PIN)</b>
        </div>

        <div class="settings-container">
            
            <div id="errorAlert" class="alert-box alert-error">Data tidak cocok. Silakan coba lagi.</div>
            <div id="successAlert" class="alert-box alert-success">PIN Login berhasil diperbarui!</div>

            <div id="step1-verify">
                <div class="section-title">Langkah 1: Verifikasi Identitas</div>
                <p style="font-size: 13px; color: #666; margin-bottom: 20px;">
                    Demi keamanan, mohon verifikasi data diri Anda sebelum mengganti PIN Login.
                </p>

                <form id="verifyForm">
                    <div class="form-group">
                        <label class="form-label">Nomor Induk Kependudukan (NIK)</label>
                        <input type="number" id="inputNik" class="form-input" placeholder="Masukkan NIK sesuai profil" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Tanggal Lahir</label>
                        <input type="date" id="inputBirthDate" class="form-input" required>
                    </div>

                    <button type="submit" id="btnVerify" class="btn-primary">Verifikasi</button>
                </form>
            </div>

            <div id="step2-change-pin">
                <div class="section-title">Langkah 2: Buat PIN Login Baru</div>
                <p style="font-size: 13px; color: #666; margin-bottom: 20px;">
                    Identitas terverifikasi. Silakan masukkan 6 digit PIN baru untuk Login.
                </p>

                <form id="changePinForm">
                    <div class="form-group">
                        <label class="form-label">PIN Baru</label>
                        <input type="password" id="newPin" class="form-input" maxlength="6" inputmode="numeric" pattern="\d{6}" placeholder="6 Angka" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Konfirmasi PIN Baru</label>
                        <input type="password" id="confirmPin" class="form-input" maxlength="6" inputmode="numeric" pattern="\d{6}" placeholder="Ulangi PIN baru" required>
                    </div>

                    <button type="submit" id="btnSavePin" class="btn-primary">Simpan & Perbarui Login</button>
                </form>
            </div>

        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        // IMPORT updatePassword DITAMBAHKAN DISINI
        import { getAuth, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqOzMh1oUnzxohMET1SsA8ZpnPm7rgjrY",
            authDomain: "aldotune-records.firebaseapp.com",
            databaseURL: "https://aldotune-records-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aldotune-records",
            storageBucket: "aldotune-records.firebasestorage.app",
            messagingSenderId: "311200667476",
            appId: "1:311200667476:web:7805289d9d01c981ef5ac1",
            measurementId: "G-GQ3Y2GKWG1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        let currentUserUid = null;
        let dbUserData = null; 

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserUid = user.uid;
                
                const userRef = ref(db, 'users/' + user.uid);
                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        dbUserData = snapshot.val();
                        let finalName = "Pengguna";
                        if (dbUserData.fullName) {
                            const words = dbUserData.fullName.trim().split(/\s+/);
                            if (words.length >= 2) finalName = words[0] + " " + words[1];
                            else finalName = words[0];
                        } else {
                            finalName = user.email.split('@')[0];
                        }
                        document.getElementById('displayName').innerText = finalName;
                    }
                });

                // Timer 15 Menit
                setTimeout(() => {
                    signOut(auth).then(() => window.location.href = "index.html");
                }, 15 * 60 * 1000);

            } else {
                window.location.href = "index.html";
            }
        });

        // --- VERIFIKASI (STEP 1) ---
        const verifyForm = document.getElementById('verifyForm');
        const errorAlert = document.getElementById('errorAlert');
        const btnVerify = document.getElementById('btnVerify');

        verifyForm.addEventListener('submit', (e) => {
            e.preventDefault();
            errorAlert.style.display = 'none';

            if (!dbUserData) {
                alert("Data pengguna belum termuat. Coba refresh.");
                return;
            }

            const inputNik = document.getElementById('inputNik').value.trim();
            const inputBirthDate = document.getElementById('inputBirthDate').value;

            // COCOKKAN DATA DENGAN DATABASE
            if (inputNik === dbUserData.nik && inputBirthDate === dbUserData.birthDate) {
                btnVerify.innerText = "Terverifikasi ✓";
                btnVerify.disabled = true;
                
                setTimeout(() => {
                    document.getElementById('step1-verify').style.display = 'none';
                    document.getElementById('step2-change-pin').style.display = 'block';
                }, 800);
            } else {
                errorAlert.innerText = "NIK atau Tanggal Lahir tidak cocok dengan data profil.";
                errorAlert.style.display = 'block';
            }
        });

        // --- UPDATE PIN (STEP 2 - PENTING) ---
        const changePinForm = document.getElementById('changePinForm');
        const btnSavePin = document.getElementById('btnSavePin');
        const successAlert = document.getElementById('successAlert');

        changePinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            errorAlert.style.display = 'none';

            const newPin = document.getElementById('newPin').value;
            const confirmPin = document.getElementById('confirmPin').value;

            // Validasi Input
            if (!/^\d+$/.test(newPin)) {
                errorAlert.innerText = "PIN harus berupa angka.";
                errorAlert.style.display = 'block';
                return;
            }
            if (newPin.length !== 6) {
                errorAlert.innerText = "PIN harus 6 digit.";
                errorAlert.style.display = 'block';
                return;
            }
            if (newPin !== confirmPin) {
                errorAlert.innerText = "Konfirmasi PIN tidak cocok.";
                errorAlert.style.display = 'block';
                return;
            }

            btnSavePin.innerText = "Memproses...";
            btnSavePin.disabled = true;

            // 1. UPDATE PASSWORD LOGIN (Firebase Auth)
            const user = auth.currentUser;
            updatePassword(user, newPin)
                .then(() => {
                    // 2. UPDATE TEXT PIN DI DATABASE (Agar sinkron)
                    return update(ref(db, 'users/' + currentUserUid), {
                        pin: newPin
                    });
                })
                .then(() => {
                    // 3. SUKSES
                    successAlert.style.display = 'block';
                    btnSavePin.innerText = "Berhasil!";
                    
                    // Logout otomatis agar user login ulang dengan PIN baru
                    setTimeout(() => {
                        alert("PIN Login berhasil diubah! Silakan login kembali dengan PIN baru.");
                        signOut(auth).then(() => {
                            window.location.href = "index.html";
                        });
                    }, 2000);
                })
                .catch((error) => {
                    // ERROR HANDLING
                    console.error("Gagal update:", error);
                    let msg = "Gagal memperbarui PIN.";
                    
                    // Jika sesi sudah terlalu lama, Firebase menolak ganti password
                    if (error.code === 'auth/requires-recent-login') {
                        msg = "Sesi kadaluarsa. Silakan Logout dan Login ulang dulu, lalu coba ganti PIN lagi.";
                    } else {
                        msg = "Error: " + error.message;
                    }

                    errorAlert.innerText = msg;
                    errorAlert.style.display = 'block';
                    btnSavePin.innerText = "Simpan PIN Baru";
                    btnSavePin.disabled = false;
                });
        });

        // --- MENU UI ---
        const userMenuBtn = document.getElementById('userMenuBtn');
        const logoutMenu = document.getElementById('logoutMenu');

        userMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            logoutMenu.style.display = (logoutMenu.style.display === 'block') ? 'none' : 'block';
        });

        document.addEventListener('click', () => {
            logoutMenu.style.display = 'none';
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            if (confirm("Yakin ingin keluar?")) {
                window.location.href = "index.html";
            }
        });
    </script>
</body>
</html>
