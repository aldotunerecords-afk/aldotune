<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Profil Saya - Aldotune</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        aldo: { 
                            black: '#0a0a0a', 
                            hover: '#f4f4f5',
                            border: '#e4e4e7' 
                        } 
                    },
                    animation: { 
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'scale-in': 'scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: { 
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        scaleIn: { '0%': { opacity: '0', transform: 'scale(0.95)' }, '100%': { opacity: '1', transform: 'scale(1)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #ffffff; }
        .sidebar-scroll::-webkit-scrollbar { width: 4px; }
        .sidebar-scroll::-webkit-scrollbar-thumb { background-color: #e5e7eb; border-radius: 4px; }
        
        .profile-input {
            width: 100%; 
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem; 
            padding: 12px 16px; 
            padding-right: 40px; 
            font-size: 0.875rem;
            font-weight: 600; 
            color: #000; 
            transition: all 0.2s;
        }
        
        .profile-input:not(:read-only):focus { 
            background-color: #fff; 
            border-color: #000; 
            outline: none; 
            box-shadow: 0 0 0 4px rgba(0,0,0,0.05);
        }

        .profile-input:read-only { 
            background-color: #f9fafb; 
            color: #4b5563; 
            cursor: pointer; 
            border-color: transparent;
        }
        
        .profile-input:read-only:hover { background-color: #f3f4f6; }
        .profile-input.permanently-disabled { background-color: #e5e7eb; color: #9ca3af; cursor: not-allowed; }

        .input-wrapper { position: relative; }
        .lock-indicator {
            position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
            color: #9ca3af; pointer-events: none; transition: opacity 0.2s;
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-black bg-white">

    <div id="toastContainer" class="fixed top-0 left-0 w-full z-[100] flex justify-center pointer-events-none p-4">
        <div id="toast" class="bg-black text-white px-6 py-4 rounded-full shadow-2xl flex items-center gap-3 transform -translate-y-24 opacity-0 transition-all duration-300 pointer-events-auto">
            <i id="toastIcon" data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            <span id="toastMessage" class="font-medium text-sm">Berhasil disimpan</span>
        </div>
    </div>

    <div id="appLoader" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-10 h-10 border-4 border-gray-100 rounded-full relative">
            <div class="w-10 h-10 border-4 border-black rounded-full border-t-transparent animate-spin absolute top-0 left-0"></div>
        </div>
        <p class="mt-4 text-xs font-bold text-gray-400 tracking-widest uppercase">Memuat Profil...</p>
    </div>

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-20 hidden lg:hidden transition-opacity duration-300 opacity-0"></div>

    <aside id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-white border-r border-aldo-border transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col h-full">
        <div class="h-20 flex items-center px-8 border-b border-gray-100 shrink-0 justify-between">
            <h1 class="text-2xl font-extrabold tracking-tighter">aldotune.</h1>
            <button onclick="toggleSidebar()" class="lg:hidden text-gray-400 hover:text-black"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>

        <div class="flex-1 overflow-y-auto sidebar-scroll py-6 px-4 space-y-8">
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Menu Utama</p>
                <nav class="space-y-1">
                    <a href="beranda.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="layout-grid" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Beranda</span>
                    </a>
                    
                    <a href="musisi.html" id="adminMenuLink" class="hidden flex items-center gap-3 px-4 py-3 text-red-600 bg-red-50 hover:bg-red-100 rounded-xl transition-all group">
                        <i data-lucide="users" class="w-5 h-5"></i>
                        <span class="text-sm font-bold">Data Musisi</span>
                    </a>

                    <a href="katalog.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="disc-3" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Katalog Musik</span>
                    </a>
                    <a href="analitik.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="bar-chart-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Analitik</span>
                    </a>
                </nav>
            </div>
            
            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Promosi & Profil</p>
                <nav class="space-y-1">
                    <a href="verifikasi.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-[#1DB954] hover:bg-green-50 rounded-xl transition-all group">
                        <i data-lucide="badge-check" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Verifikasi Spotify</span>
                    </a>
                    <a href="playlist.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="list-music" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Playlist Spotify</span>
                    </a>
                    <a href="promosi.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="megaphone" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Promosi</span>
                    </a>
                </nav>
            </div>

            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Manajemen Aset</p>
                <nav class="space-y-1">
                    <a href="publishing.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="globe" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Publishing</span>
                    </a>
                    <a href="lirik.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="mic-2" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Lirik & Sync</span>
                    </a>
                    <a href="hakcipta.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="shield-check" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Hak Cipta / Legal</span>
                    </a>
                </nav>
            </div>

            <div>
                <p class="px-4 text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-3">Keuangan</p>
                <nav class="space-y-1">
                    <a href="dompet.html" class="flex items-center gap-3 px-4 py-3 text-gray-500 hover:text-black hover:bg-aldo-hover rounded-xl transition-all group">
                        <i data-lucide="wallet" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                        <span class="text-sm font-medium">Dompet & Royalti</span>
                    </a>
                </nav>
            </div>
        </div>
    </aside>

    <div id="mainContent" class="flex-1 flex flex-col lg:pl-64 h-full relative">
        
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-aldo-border flex items-center justify-between px-6 sticky top-0 z-20">
            <button onclick="toggleSidebar()" class="p-2 -ml-2 mr-2 text-black hover:bg-gray-100 rounded-lg">
                <i data-lucide="menu" class="w-6 h-6"></i>
            </button>
            <div class="flex-1"></div>
            <div class="flex items-center gap-3">
                <a href="upload.html" class="bg-black hover:bg-gray-800 text-white text-sm font-bold px-5 py-2.5 rounded-full flex items-center gap-2 transition-all shadow-lg shadow-black/20">
                    <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                    <span class="hidden sm:inline">Rilis Baru</span>
                </a>
                <div class="h-8 w-[1px] bg-gray-200 mx-1"></div>
                <div class="relative">
                    <button id="profileBtn" onclick="toggleProfileMenu()" class="flex items-center gap-2 pl-2 pr-1 py-1 rounded-full hover:bg-gray-50 border border-transparent hover:border-gray-200 transition-all group select-none">
                        <div class="text-right hidden md:block">
                            <p id="navUserName" class="text-xs font-bold text-black leading-none skeleton h-3 w-16 rounded mb-1"></p>
                            <p class="text-[10px] text-gray-400 font-medium">Akun Saya</p>
                        </div>
                        <img id="navUserImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" class="w-9 h-9 rounded-full bg-gray-200 object-cover border border-gray-100 group-hover:scale-105 transition-transform">
                        <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400"></i>
                    </button>
                    <div id="profileMenu" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-2xl shadow-xl border border-gray-100 p-2 z-50">
                        <a href="profil.html" class="flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-black bg-gray-50 rounded-xl">
                            <i data-lucide="user" class="w-4 h-4"></i> Lihat Profil
                        </a>
                        <a href="pin-transaksi.html" class="flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-gray-600 hover:text-black hover:bg-gray-50 rounded-xl transition-colors">
                            <i data-lucide="key" class="w-4 h-4"></i> Ubah PIN Transaksi
                        </a>
                        <a href="reset.html" class="flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-gray-600 hover:text-black hover:bg-gray-50 rounded-xl transition-colors">
                            <i data-lucide="lock" class="w-4 h-4"></i> Ubah PIN Akses
                        </a>
                        <div class="h-[1px] bg-gray-100 my-1"></div>
                        <button onclick="openLogoutModal()" class="w-full flex items-center gap-3 px-3 py-2.5 text-sm font-bold text-red-600 hover:bg-red-50 rounded-xl text-left">
                            <i data-lucide="log-out" class="w-4 h-4"></i> Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-1 overflow-y-auto p-6 md:p-10 bg-white">
            <div class="max-w-3xl mx-auto space-y-8 opacity-0 animate-fade-in pb-32">
                
                <div class="flex flex-col md:flex-row items-center gap-6 md:gap-8 pb-8 border-b border-gray-100">
                    <div class="relative group">
                        <img id="profilePageImg" src="" class="w-28 h-28 md:w-32 md:h-32 rounded-full border-4 border-gray-50 shadow-sm object-cover bg-gray-200">
                    </div>
                    <div class="text-center md:text-left flex-1">
                        <h2 id="profileName" class="text-2xl md:text-3xl font-extrabold text-black mb-1 skeleton h-8 w-48 rounded inline-block"></h2>
                        <div class="flex flex-wrap justify-center md:justify-start gap-2 mb-3">
                            <span class="px-2 py-1 rounded-md bg-black text-white text-[10px] font-bold uppercase tracking-widest">ARTIS / LABEL</span>
                            <span class="px-2 py-1 rounded-md bg-blue-50 text-blue-600 text-[10px] font-bold uppercase tracking-widest flex items-center gap-1">
                                <i data-lucide="badge-check" class="w-3 h-3"></i> Terverifikasi
                            </span>
                        </div>
                        <p class="text-sm text-gray-500">Anggota sejak: <span id="joinDate">-</span></p>
                    </div>
                </div>

                <form id="profileForm" class="space-y-6">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-bold text-black">Informasi Pribadi</h3>
                        <p class="text-xs text-gray-400 font-medium">Klik kolom untuk mengedit.</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">Nama Lengkap</label>
                            <div class="input-wrapper">
                                <input type="text" id="inputName" class="profile-input" readonly onclick="enableEdit(this)" required>
                                <i data-lucide="lock" class="w-3 h-3 lock-indicator"></i>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">Email (Login ID)</label>
                            <div class="input-wrapper">
                                <input type="email" id="inputEmail" class="profile-input permanently-disabled" disabled>
                                <i data-lucide="lock" class="w-3 h-3 absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">NIK (Identitas)</label>
                            <div class="input-wrapper">
                                <input type="number" id="inputNik" class="profile-input font-mono" readonly onclick="enableEdit(this)" required>
                                <i data-lucide="lock" class="w-3 h-3 lock-indicator"></i>
                            </div>
                        </div>

                        <div class="space-y-1">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">Nomor WhatsApp</label>
                            <div class="input-wrapper">
                                <input type="number" id="inputWa" class="profile-input" placeholder="628..." readonly onclick="enableEdit(this)" required>
                                <i data-lucide="lock" class="w-3 h-3 lock-indicator"></i>
                            </div>
                        </div>

                        <div class="space-y-1 md:col-span-2">
                            <label class="text-xs font-bold text-gray-400 uppercase tracking-widest">Tanggal Lahir</label>
                            <div class="input-wrapper">
                                <input type="date" id="inputBirth" class="profile-input" readonly onclick="enableEdit(this)" required>
                                <i data-lucide="lock" class="w-3 h-3 lock-indicator"></i>
                            </div>
                        </div>
                    </div>

                    <div class="pt-6 border-t border-gray-100 flex flex-col-reverse md:flex-row gap-4 items-center justify-end">
                        <button type="submit" id="saveBtn" class="w-full md:w-auto px-8 h-12 bg-black text-white font-bold rounded-full hover:bg-gray-800 transition-all flex items-center justify-center gap-2 shadow-lg shadow-black/10">
                            <span>Simpan Perubahan</span>
                            <i data-lucide="save" class="w-4 h-4"></i>
                        </button>
                    </div>
                </form>

                <div class="mt-8">
                     <h3 class="text-lg font-bold text-black mb-4">Langganan & Paket</h3>
                     <div class="bg-white border border-gray-200 p-6 rounded-3xl flex flex-col md:flex-row items-center justify-between gap-4 shadow-sm">
                         <div class="flex items-center gap-4">
                             <div class="w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-600 shrink-0">
                                 <i data-lucide="zap" class="w-6 h-6"></i>
                             </div>
                             <div>
                                 <p class="font-bold text-black text-lg">Paket Distribusi</p>
                                 <p class="text-sm text-gray-500">Kelola batas upload dan fitur akun Anda.</p>
                             </div>
                         </div>
                         <a href="paket.html" class="w-full md:w-auto px-6 py-3 bg-black text-white font-bold rounded-xl text-sm hover:bg-gray-800 transition-all flex items-center justify-center gap-2">
                             Ubah Detail Paket <i data-lucide="arrow-right" class="w-4 h-4"></i>
                         </a>
                     </div>
                </div>

                <div class="bg-red-50 rounded-3xl p-6 border border-red-100 mt-12">
                    <h3 class="text-lg font-bold text-red-600 mb-2">Zona Bahaya</h3>
                    <p class="text-sm text-red-500 mb-6 leading-relaxed">
                        Menghapus akun akan menghilangkan semua data katalog, royalti, dan akses selamanya. Data di database dan akun login akan dihapus total. Tindakan ini tidak dapat dibatalkan.
                    </p>
                    <button onclick="requestDeleteAccount()" class="px-6 py-3 bg-white border border-red-200 text-red-600 font-bold rounded-xl text-sm hover:bg-red-600 hover:text-white transition-all shadow-sm">
                        Hapus Akun Permanen
                    </button>
                </div>
                
                <div class="h-24"></div>

            </div>
        </main>
    </div>

    <div id="pinModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden opacity-0 flex items-center justify-center p-4 transition-all duration-300">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform scale-95 transition-all">
            <div class="w-12 h-12 rounded-full bg-gray-100 flex items-center justify-center mx-auto mb-4 text-black">
                <i data-lucide="lock" class="w-6 h-6"></i>
            </div>
            <div class="text-center mb-6">
                <h3 id="pinModalTitle" class="text-xl font-bold text-black mb-1">Verifikasi PIN</h3>
                <p id="pinModalDesc" class="text-gray-500 text-sm">Masukkan PIN Transaksi untuk melanjutkan.</p>
            </div>
            
            <div class="relative mb-6">
                <input type="password" id="transPinInput" maxlength="6" inputmode="numeric" pattern="\d{6}" class="w-full text-center text-2xl font-bold font-mono tracking-[0.5em] border-b-2 border-gray-200 py-2 focus:outline-none focus:border-black transition-colors" placeholder="••••••">
            </div>

            <div class="flex gap-3">
                <button onclick="closePinModal()" class="flex-1 py-3 rounded-xl font-bold text-black bg-gray-100 hover:bg-gray-200">Batal</button>
                <button onclick="submitPin()" id="pinSubmitBtn" class="flex-1 py-3 rounded-xl font-bold text-white bg-black hover:bg-gray-800">Verifikasi</button>
            </div>
        </div>
    </div>

    <div id="logoutModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[200] hidden opacity-0 flex items-center justify-center p-4 transition-all duration-300">
        <div class="bg-white w-full max-w-sm rounded-3xl p-6 shadow-2xl transform scale-95 transition-all">
            <div class="w-12 h-12 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-4 text-red-600"><i data-lucide="log-out" class="w-6 h-6"></i></div>
            <div class="text-center mb-6"><h3 class="text-xl font-bold text-black mb-1">Konfirmasi</h3><p class="text-gray-500 text-sm">Pilih tindakan untuk akun Anda.</p></div>
            <div class="space-y-3">
                <button onclick="handleSoftExit()" class="w-full py-3 rounded-xl font-bold text-black bg-gray-100 hover:bg-gray-200 transition-colors flex items-center justify-center gap-2">Keluar <span class="text-xs font-medium text-gray-500">(Ke Halaman Login)</span></button>
                <button onclick="handleHardLogout()" class="w-full py-3 rounded-xl font-bold text-white bg-black hover:bg-gray-800 transition-colors">Akhiri Sesi (Logout)</button>
                <button onclick="closeLogoutModal()" class="w-full py-2 text-sm font-bold text-gray-400 hover:text-black mt-2">Batal</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, deleteUser } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get, update, remove, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqOzMh1oUnzxohMET1SsA8ZpnPm7rgjrY",
            authDomain: "aldotune-records.firebaseapp.com",
            databaseURL: "https://aldotune-records-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aldotune-records",
            storageBucket: "aldotune-records.firebasestorage.app",
            messagingSenderId: "311200667476",
            appId: "1:311200667476:web:7805289d9d01c981ef5ac1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const els = {
            appLoader: document.getElementById('appLoader'),
            navUserName: document.getElementById('navUserName'),
            navUserImg: document.getElementById('navUserImg'),
            profileName: document.getElementById('profileName'),
            profilePageImg: document.getElementById('profilePageImg'),
            joinDate: document.getElementById('joinDate'),
            adminMenu: document.getElementById('adminMenuLink'),
            profileMenu: document.getElementById('profileMenu'),
            inputName: document.getElementById('inputName'),
            inputEmail: document.getElementById('inputEmail'),
            inputNik: document.getElementById('inputNik'),
            inputWa: document.getElementById('inputWa'),
            inputBirth: document.getElementById('inputBirth'),
            toast: document.getElementById('toast'),
            pinModal: document.getElementById('pinModal'),
            transPinInput: document.getElementById('transPinInput')
        };

        let activeUser = null;
        let pendingAction = null; 
        let pendingData = null;

        window.enableEdit = (input) => {
            input.readOnly = false;
            input.focus();
            const wrapper = input.parentElement;
            const icon = wrapper.querySelector('.lock-indicator');
            if(icon) icon.style.opacity = '0';
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                activeUser = user;
                loadUserData(user);
            } else {
                window.location.replace("login.html");
            }
        });

        function loadUserData(user) {
            const uid = user.uid;
            const avatarUrl = user.photoURL || `https://ui-avatars.com/api/?name=${user.email.substring(0,2)}&background=random`;
            els.navUserImg.src = avatarUrl;
            els.profilePageImg.src = avatarUrl;

            get(child(ref(db), `users/${uid}`)).then((snapshot) => {
                const data = snapshot.val();
                
                if (data && data.j === "a") els.adminMenu.classList.remove('hidden');
                else els.adminMenu.classList.add('hidden');

                els.navUserName.classList.remove('skeleton', 'text-transparent');
                els.profileName.classList.remove('skeleton', 'text-transparent');

                const name = data?.fullName || user.displayName || "Artis";
                
                els.navUserName.innerText = name.split(' ')[0];
                els.profileName.innerText = name;
                
                els.inputName.value = name;
                els.inputEmail.value = user.email;
                els.inputNik.value = data?.nik || "";
                els.inputWa.value = data?.whatsapp || "";
                els.inputBirth.value = data?.birthDate || "";
                
                if(data?.registrationDate) {
                    const d = new Date(data.registrationDate);
                    els.joinDate.innerText = d.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' });
                }

                setTimeout(() => els.appLoader.classList.add('opacity-0', 'pointer-events-none'), 500);
            }).catch(e => {
                console.error(e);
                els.appLoader.classList.add('opacity-0', 'pointer-events-none');
            });
        }

        document.getElementById('profileForm').addEventListener('submit', (e) => {
            e.preventDefault();
            pendingAction = 'save';
            pendingData = {
                fullName: els.inputName.value,
                nik: els.inputNik.value,
                whatsapp: els.inputWa.value,
                birthDate: els.inputBirth.value,
                updatedAt: Date.now()
            };
            openPinModal("Simpan Perubahan", "Masukkan PIN Transaksi untuk menyimpan data.");
        });

        window.requestDeleteAccount = () => {
            pendingAction = 'delete';
            openPinModal("Hapus Akun Permanen", "PERINGATAN: Masukkan PIN Transaksi untuk MENGHAPUS SEMUA DATA. Tindakan ini tidak bisa dibatalkan.");
        };

        window.submitPin = () => {
            const enteredPin = els.transPinInput.value;
            if (enteredPin.length !== 6) return alert("PIN harus 6 digit");
            
            const btn = document.getElementById('pinSubmitBtn');
            btn.disabled = true;
            btn.innerText = "Memeriksa...";

            const uid = activeUser.uid;

            get(child(ref(db), `users/${uid}/pin`)).then((snapshot) => {
                const dbPin = snapshot.val();
                
                if (String(dbPin) === String(enteredPin)) {
                    if (pendingAction === 'save') {
                        executeSaveProfile(uid);
                    } else if (pendingAction === 'delete') {
                        executeDeleteAccount(uid);
                    }
                } else {
                    alert("PIN Transaksi Salah!");
                    btn.disabled = false;
                    btn.innerText = "Verifikasi";
                    els.transPinInput.value = "";
                }
            }).catch(err => {
                alert("Error verifikasi: " + err.message);
                btn.disabled = false;
                btn.innerText = "Verifikasi";
            });
        };

        function executeSaveProfile(uid) {
            if (!pendingData) {
                alert("Gagal: Data tidak ditemukan.");
                closePinModal();
                return;
            }

            update(ref(db, `users/${uid}`), pendingData)
                .then(() => {
                    els.navUserName.innerText = pendingData.fullName.split(' ')[0];
                    els.profileName.innerText = pendingData.fullName;
                    showToast("Profil berhasil diperbarui.");
                    resetInputsLock();
                    closePinModal();
                })
                .catch(err => {
                    alert("Gagal simpan: " + err.message);
                    closePinModal();
                });
        }

        function resetInputsLock() {
            const inputs = [els.inputName, els.inputNik, els.inputWa, els.inputBirth];
            inputs.forEach(input => {
                input.readOnly = true;
                const wrapper = input.parentElement;
                const icon = wrapper.querySelector('.lock-indicator');
                if(icon) icon.style.opacity = '1';
            });
        }

        function executeDeleteAccount(uid) {
            remove(ref(db, `users/${uid}`))
                .then(() => {
                    deleteUser(activeUser).then(() => {
                        alert("Akun berhasil dihapus permanen. Sampai jumpa.");
                        window.location.replace("login.html");
                    }).catch((error) => {
                        if (error.code === 'auth/requires-recent-login') {
                            alert("Demi keamanan, silakan login ulang lalu coba hapus akun kembali.");
                            signOut(auth).then(() => window.location.replace("login.html"));
                        } else {
                            alert("Gagal hapus akun Auth: " + error.message);
                        }
                    });
                })
                .catch(err => alert("Gagal hapus database: " + err.message));
        }

        window.openPinModal = (title, desc) => {
            document.getElementById('pinModalTitle').innerText = title;
            document.getElementById('pinModalDesc').innerText = desc;
            els.transPinInput.value = "";
            document.getElementById('pinSubmitBtn').disabled = false;
            document.getElementById('pinSubmitBtn').innerText = "Verifikasi";
            els.pinModal.classList.remove('hidden', 'opacity-0');
        };

        window.closePinModal = () => {
            els.pinModal.classList.add('opacity-0');
            setTimeout(() => {
                els.pinModal.classList.add('hidden');
            }, 300);
        };

        function showToast(msg) {
            document.getElementById('toastMessage').innerText = msg || "Berhasil";
            els.toast.classList.remove('-translate-y-24', 'opacity-0');
            setTimeout(() => els.toast.classList.add('-translate-y-24', 'opacity-0'), 3000);
        }

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const mainContent = document.getElementById('mainContent');
            if (window.innerWidth < 1024) {
                if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); overlay.classList.remove('hidden', 'opacity-0'); }
                else { sidebar.classList.add('-translate-x-full'); overlay.classList.add('opacity-0'); setTimeout(() => overlay.classList.add('hidden'), 300); }
            } else {
                if (sidebar.classList.contains('-translate-x-full')) { sidebar.classList.remove('-translate-x-full'); mainContent.classList.add('lg:pl-64'); mainContent.classList.remove('lg:pl-0'); }
                else { sidebar.classList.add('-translate-x-full'); mainContent.classList.remove('lg:pl-64'); mainContent.classList.add('lg:pl-0'); }
            }
        };

        window.toggleProfileMenu = () => els.profileMenu.classList.toggle('hidden');
        document.addEventListener('click', (e) => { if (!document.getElementById('profileBtn').contains(e.target) && !els.profileMenu.contains(e.target)) els.profileMenu.classList.add('hidden'); });

        window.openLogoutModal = () => { els.profileMenu.classList.add('hidden'); document.getElementById('logoutModal').classList.remove('hidden', 'opacity-0'); };
        window.closeLogoutModal = () => { const m = document.getElementById('logoutModal'); m.classList.add('opacity-0'); setTimeout(() => m.classList.add('hidden'), 300); };
        window.handleSoftExit = () => window.location.href = "login.html";
        window.handleHardLogout = () => signOut(auth).then(() => window.location.replace("login.html"));

        lucide.createIcons();
    </script>
</body>
</html>