<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pengaturan > Profil - Aldotune</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><text x='50%' y='50%' dy='.35em' text-anchor='middle' font-size='65' font-family='Arial, sans-serif' font-weight='bold' fill='%23000000'>a</text></svg>">

    <style>
        /* --- 1. GLOBAL RESET --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        
        /* Body dikunci agar sidebar tetap, tapi konten bisa scroll */
        body { 
            background-color: #f6f6f6; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; /* Mencegah body ikut scroll */
            color: #333; 
        }
        a { text-decoration: none; color: inherit; }

        /* --- 2. HEADER (Fixed Top) --- */
        .top-header {
            height: 64px;
            background-color: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            position: fixed; /* Header Melayang Tetap */
            top: 0; left: 0; right: 0;
            z-index: 100;
        }

        .header-left { display: flex; align-items: center; gap: 15px; }

        .btn-back {
            display: flex; align-items: center; justify-content: center;
            width: 40px; height: 40px;
            border-radius: 50%;
            transition: background 0.2s;
            color: #555;
        }
        .btn-back:hover { background-color: #f0f0f0; }
        .btn-back svg { width: 24px; height: 24px; fill: currentColor; }

        .page-title { font-size: 18px; font-weight: 600; color: #222; }

        .user-profile { display: flex; align-items: center; text-align: right; gap: 12px; cursor: pointer; }
        .user-details h4 { font-size: 13px; font-weight: 600; color: #333; margin: 0; text-transform: capitalize; }
        .avatar-icon { width: 34px; height: 34px; fill: #999; flex-shrink: 0; }

        /* Dropdown Logout */
        .logout-menu { 
            position: absolute; top: 60px; right: 20px; background: white; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border-radius: 8px; 
            overflow: hidden; display: none; z-index: 101; min-width: 200px; 
            border: 1px solid #eee;
        }
        .dropdown-item { 
            display: flex; align-items: center; width: 100%; padding: 12px 20px; 
            background: transparent; border: none; text-align: left; cursor: pointer; 
            color: #555; font-size: 14px; transition: 0.2s; 
        }
        .dropdown-item:hover { background-color: #f9f9f9; color: #000; }
        .dropdown-item svg { width: 18px; height: 18px; margin-right: 12px; fill: #777; }
        .dropdown-divider { height: 1px; background-color: #eee; margin: 0; }

        /* --- 3. KONTEN UTAMA (SCROLLABLE AREA) --- */
        .main-wrapper {
            margin-top: 64px; /* Memberi ruang untuk header fixed */
            flex-grow: 1;
            width: 100%;
            height: calc(100vh - 64px); /* Sisa tinggi layar */
            overflow-y: auto; /* Scroll vertikal aktif di sini */
            -webkit-overflow-scrolling: touch; /* Scroll smooth di tablet/HP */
            padding-bottom: 150px; /* LONGGAR DI BAWAH (Agar tidak terpotong) */
        }

        .content-area {
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }

        .breadcrumb-container {
            padding: 25px 30px;
            font-size: 14px;
            color: #777;
        }
        .breadcrumb-container b { color: #333; }
        .chevron { margin: 0 8px; font-size: 12px; color: #ccc; }

        /* CONTAINER PUTIH */
        .profile-table-container {
            background-color: white;
            width: 100%;
            padding: 10px 35px 50px 35px; 
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
            /* Pastikan tinggi minimal cukup tapi tidak memaksa scroll jika konten sedikit */
            min-height: auto; 
            margin-bottom: 100px; /* Tambahan jarak bawah */
        }

        /* --- STYLE BARIS DATA --- */
        .profile-row {
            display: flex;
            align-items: center;
            padding: 22px 0;
            border-bottom: 1px solid #f7f7f7;
        }
        .profile-row:last-child { border-bottom: none; }

        .row-label {
            width: 250px;
            font-size: 14px;
            font-weight: 700;
            color: #444;
            flex-shrink: 0;
        }

        .row-value {
            font-size: 14px;
            color: #666;
            flex-grow: 1;
            font-weight: 500;
            word-break: break-all;
        }

        /* JUDUL BAGIAN */
        .section-title {
            font-size: 12px;
            color: #999;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 30px 0 15px 0;
        }

        .section-divider {
            border: 0; height: 1px; background: #eee; margin: 0;
        }

        /* KOTAK INFO */
        .info-box {
            margin-top: 40px;
            background-color: #fffbe6;
            border: 1px solid #ffe58f;
            padding: 15px;
            border-radius: 6px;
            color: #d48806;
            font-size: 13px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            line-height: 1.5;
        }
        .info-box svg { width: 20px; height: 20px; fill: #d48806; flex-shrink: 0; }

        /* RESPONSIVE MOBILE & TABLET */
        @media (max-width: 768px) {
            .top-header { padding: 0 15px; }
            .breadcrumb-container { padding: 20px; }
            
            /* Agar di tablet/HP container tidak mepet */
            .profile-table-container { 
                padding: 10px 20px 40px 20px; 
                border-radius: 0; 
                margin-bottom: 150px; /* Extra longgar di mobile */
            }
            
            .profile-row { 
                flex-direction: column; 
                align-items: flex-start; 
                padding: 15px 0; 
            }
            .row-label { 
                width: 100%; 
                margin-bottom: 6px; 
                color: #888; 
                font-size: 12px; 
                text-transform: uppercase; 
            }
            .row-value { 
                font-size: 15px; 
                color: #222; 
            }
            .user-details { display: none; }
        }
    </style>
</head>
<body>

    <header class="top-header">
        <div class="header-left">
            <a href="rumah.html" class="btn-back">
                <svg viewBox="0 0 24 24"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
            </a>
            <div class="page-title">Profil</div>
        </div>

        <div class="user-profile" id="userMenuBtn">
            <div class="user-details">
                <h4 id="displayName">Memuat...</h4>
            </div>
            <svg class="avatar-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/></svg>
        </div>

        <div class="logout-menu" id="logoutMenu">
            <a href="profil.html" class="dropdown-item">Profil</a>
            <a href="sandi.html" class="dropdown-item">Kata Sandi</a>
            <a href="layanan.html" class="dropdown-item">Layanan tambahan</a>
            <div class="dropdown-divider"></div>
            <button id="btnLogout" class="dropdown-item" style="color: #d93025;">Keluar</button>
        </div>
    </header>

    <main class="main-wrapper">
        
        <div class="content-area">
            <div class="breadcrumb-container">
                Pengaturan <span class="chevron">â€º</span> <b>Profil</b>
            </div>

            <div class="profile-table-container">
                
                <div class="section-title" style="margin-top: 0;">Data Pribadi</div>

                <div class="profile-row">
                    <div class="row-label">Nama Lengkap</div>
                    <div class="row-value" id="profileName">...</div>
                </div>

                <div class="profile-row">
                    <div class="row-label">NIK</div>
                    <div class="row-value" id="profileNIK">...</div>
                </div>

                <div class="profile-row">
                    <div class="row-label">ID Akun</div>
                    <div class="row-value" id="profileUID">...</div>
                </div>

                <div class="profile-row">
                    <div class="row-label">Tanggal Lahir</div>
                    <div class="row-value" id="profileBirthDate">...</div>
                </div>

                <div class="profile-row">
                    <div class="row-label">Alamat email</div>
                    <div class="row-value" id="profileEmail">...</div>
                </div>

                <div class="profile-row">
                    <div class="row-label">WhatsApp</div>
                    <div class="row-value" id="profileWA">...</div>
                </div>

                <div class="section-title">Detail Bank</div>

                <div class="profile-row">
                    <div class="row-label">Nama Bank</div>
                    <div class="row-value" id="bankName">...</div>
                </div>

                <div class="profile-row">
                    <div class="row-label">Nomor Rekening</div>
                    <div class="row-value" id="bankAccNum">...</div>
                </div>

                <div class="profile-row">
                    <div class="row-label">Nama Penerima</div>
                    <div class="row-value" id="bankAccOwner">...</div>
                </div>

                <div class="info-box">
                    <svg viewBox="0 0 24 24"><path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/></svg>
                    <span>Data ini bersifat permanen untuk keamanan. Jika ingin memperbarui data, silakan hubungi <b>Tim Aldotune</b> atau datang langsung ke <b>Studio</b>.</span>
                </div>

            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqOzMh1oUnzxohMET1SsA8ZpnPm7rgjrY",
            authDomain: "aldotune-records.firebaseapp.com",
            databaseURL: "https://aldotune-records-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aldotune-records",
            storageBucket: "aldotune-records.firebasestorage.app",
            messagingSenderId: "311200667476",
            appId: "1:311200667476:web:7805289d9d01c981ef5ac1",
            measurementId: "G-GQ3Y2GKWG1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // --- TIMER SESI 15 MENIT ---
        const SESSION_TIMEOUT = 15 * 60 * 1000; 
        let sessionTimer;

        function secureLogout() {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        }

        function startSessionTimer() {
            sessionTimer = setTimeout(() => {
                secureLogout();
            }, SESSION_TIMEOUT);
        }

        // --- FETCH DATA ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                startSessionTimer();
                
                // Isi Data Dasar (Auth)
                document.getElementById('profileEmail').innerText = user.email;
                document.getElementById('profileUID').innerText = user.uid; // Tampilkan Full UID

                // Fetch Database
                const userRef = ref(db, 'users/' + user.uid);
                get(userRef).then((snapshot) => {
                    let finalName = "Pengguna"; 
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        
                        // 1. Nama Lengkap
                        if (userData.fullName) {
                            document.getElementById('profileName').innerText = userData.fullName;
                            const words = userData.fullName.trim().split(/\s+/);
                            if (words.length >= 2) finalName = words[0] + " " + words[1];
                            else finalName = words[0];
                        }

                        // 2. Data Pribadi Lainnya
                        document.getElementById('profileNIK').innerText = userData.nik || "-";
                        document.getElementById('profileBirthDate').innerText = userData.birthDate || "-";
                        document.getElementById('profileWA').innerText = userData.whatsapp || "-";

                        // 3. Detail Bank (Nested)
                        if (userData.bankDetails) {
                            document.getElementById('bankName').innerText = userData.bankDetails.bankName || "-";
                            document.getElementById('bankAccNum').innerText = userData.bankDetails.accountNumber || "-";
                            document.getElementById('bankAccOwner').innerText = userData.bankDetails.accountOwner || "-";
                        } else {
                            // Kosongkan jika tidak ada data bank
                            document.getElementById('bankName').innerText = "-";
                            document.getElementById('bankAccNum').innerText = "-";
                            document.getElementById('bankAccOwner').innerText = "-";
                        }
                    }
                    document.getElementById('displayName').innerText = finalName;
                }).catch((error) => {
                    console.error("Error getting data:", error);
                });
            } else {
                window.location.href = "index.html";
            }
        });

        // --- USER MENU TOGGLE ---
        const userMenuBtn = document.getElementById('userMenuBtn');
        const logoutMenu = document.getElementById('logoutMenu');

        userMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            logoutMenu.style.display = (logoutMenu.style.display === 'block') ? 'none' : 'block';
        });

        document.addEventListener('click', () => {
            logoutMenu.style.display = 'none';
        });

        document.getElementById('btnLogout').addEventListener('click', () => {
            if (confirm("Yakin ingin keluar?")) {
                window.location.href = "index.html";
            }
        });
    </script>
</body>
</html>
