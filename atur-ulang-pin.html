<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Buat PIN Baru - Aldotune Creative Studio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { aldo: { black: '#0a0a0a' } },
                    animation: { 'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards' },
                    keyframes: { slideUp: { '0%': { opacity: '0', transform: 'translateY(20px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        html, body { margin: 0; background-color: #ffffff; height: 100%; overflow-x: hidden; }
        .minimal-input {
            width: 100%; background-color: transparent; border-bottom: 2px solid #e5e7eb;
            border-top: none; border-left: none; border-right: none; border-radius: 0;
            padding: 12px 0; font-size: 1.125rem; transition: all 0.3s ease; font-family: 'Inter', monospace; letter-spacing: 0.2em;
        }
        .minimal-input:focus { border-bottom-color: #000000; outline: none; }
        .view-active { animation: slideUp 0.4s forwards; }
    </style>
</head>
<body class="flex flex-col w-full min-h-screen">

    <div id="toastContainer" class="fixed top-0 left-0 w-full z-[100] flex justify-center pointer-events-none p-4">
        <div id="toast" class="bg-black text-white px-6 py-4 rounded-full shadow-2xl flex items-center gap-3 transform -translate-y-20 opacity-0 transition-all duration-300 pointer-events-auto">
            <i data-lucide="check-circle" class="w-5 h-5 text-green-400"></i>
            <div><span class="font-bold text-sm block">Berhasil</span><span class="text-xs text-gray-400">PIN Anda telah diperbarui.</span></div>
        </div>
    </div>

    <div class="flex flex-col lg:flex-row w-full flex-grow relative">

        <div class="hidden lg:flex lg:w-1/2 bg-black relative items-center justify-center overflow-hidden lg:h-screen lg:sticky lg:top-0">
            <img src="https://images.unsplash.com/photo-1516280440614-6697288d5d38?q=80&w=2070&auto=format&fit=crop" class="absolute inset-0 w-full h-full object-cover opacity-40 grayscale">
            <div class="relative z-10 p-16 text-white max-w-xl flex flex-col justify-center h-full">
                <h2 class="text-5xl font-extrabold tracking-tighter mb-4">Secure Access.</h2>
                <p class="text-xl text-gray-300 font-light leading-relaxed">Buat PIN baru untuk melindungi royalti dan aset digital Anda.</p>
            </div>
        </div>

        <div class="w-full lg:w-1/2 bg-white flex flex-col relative justify-center min-h-screen">
            
            <div id="verifyingState" class="absolute inset-0 bg-white z-20 flex flex-col items-center justify-center">
                <div class="w-12 h-12 border-4 border-gray-100 rounded-full relative mb-4">
                    <div class="w-12 h-12 border-4 border-black rounded-full border-t-transparent animate-spin absolute top-0 left-0"></div>
                </div>
                <p class="text-sm font-bold text-gray-400 uppercase tracking-widest animate-pulse">Memverifikasi Tautan...</p>
            </div>

            <div class="w-full px-8 py-12 flex flex-col justify-center items-center">
                
                <div id="errorState" class="hidden max-w-md w-full text-center">
                    <div class="w-20 h-20 rounded-full bg-red-50 flex items-center justify-center mx-auto mb-6"><i data-lucide="x-circle" class="w-10 h-10 text-red-500"></i></div>
                    <h2 class="text-3xl font-extrabold text-black mb-2">Tautan Kadaluarsa</h2>
                    <p class="text-gray-500 mb-8">Link reset ini sudah tidak valid atau sudah digunakan sebelumnya.</p>
                    <a href="reset.html" class="block w-full bg-black text-white font-bold h-14 rounded-full flex items-center justify-center">Kirim Ulang Email</a>
                </div>

                <div id="formState" class="hidden max-w-md w-full view-active">
                    <div class="mb-10">
                        <h1 class="text-4xl font-extrabold tracking-tighter text-black mb-2">PIN Baru</h1>
                        <p class="text-gray-500 font-medium">Masukkan 6 digit angka untuk akses akun Anda.</p>
                    </div>

                    <form id="newPinForm" class="space-y-8">
                        <div class="group relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">PIN Baru (6 Digit)</label>
                            <div class="relative">
                                <input type="password" id="newPin" maxlength="6" inputmode="numeric" pattern="\d{6}" class="minimal-input text-black font-bold" placeholder="••••••" required>
                                <button type="button" id="toggleNew" class="absolute right-0 bottom-3 text-gray-400 hover:text-black"><i data-lucide="eye" class="w-5 h-5"></i></button>
                            </div>
                        </div>

                        <div class="group relative">
                            <label class="block text-xs font-bold text-gray-400 uppercase tracking-widest mb-1">Konfirmasi PIN</label>
                            <div class="relative">
                                <input type="password" id="confirmPin" maxlength="6" inputmode="numeric" pattern="\d{6}" class="minimal-input text-black font-bold" placeholder="••••••" required>
                                <button type="button" id="toggleConfirm" class="absolute right-0 bottom-3 text-gray-400 hover:text-black"><i data-lucide="eye" class="w-5 h-5"></i></button>
                            </div>
                            <p id="matchError" class="hidden text-xs text-red-500 font-bold mt-2 text-right">PIN tidak cocok.</p>
                        </div>

                        <div class="pt-4">
                            <button type="submit" id="submitBtn" class="w-full bg-black text-white font-bold h-16 rounded-full flex items-center justify-center gap-2 shadow-lg hover:shadow-xl hover:bg-gray-900 transition-all duration-200">
                                <span id="btnText">Simpan PIN Baru</span>
                                <div id="btnLoader" class="hidden"><svg class="animate-spin h-5 w-5 text-white" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>
                            </button>
                        </div>
                    </form>
                </div>
                
                <div id="successState" class="hidden max-w-md w-full text-center view-active">
                    <div class="w-20 h-20 rounded-full bg-green-50 flex items-center justify-center mx-auto mb-6"><i data-lucide="check" class="w-10 h-10 text-green-500"></i></div>
                    <h2 class="text-3xl font-extrabold text-black mb-2">Berhasil!</h2>
                    <p class="text-gray-500 mb-8">PIN Akses Anda telah diperbarui. Mengalihkan ke halaman masuk...</p>
                </div>

            </div>
            
            <div class="absolute bottom-6 w-full text-center">
                <p class="text-xs text-gray-400 font-medium">&copy; 2026 PT. Aldotune Creative Studio.</p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, verifyPasswordResetCode, confirmPasswordReset } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAqOzMh1oUnzxohMET1SsA8ZpnPm7rgjrY",
            authDomain: "aldotune-records.firebaseapp.com",
            projectId: "aldotune-records",
            storageBucket: "aldotune-records.firebasestorage.app",
            messagingSenderId: "311200667476",
            appId: "1:311200667476:web:7805289d9d01c981ef5ac1"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // Ambil kode aksi (oobCode) dari URL
        const urlParams = new URLSearchParams(window.location.search);
        const actionCode = urlParams.get('oobCode');

        // Elemen UI
        const els = {
            verifying: document.getElementById('verifyingState'),
            form: document.getElementById('formState'),
            error: document.getElementById('errorState'),
            success: document.getElementById('successState'),
            newPin: document.getElementById('newPin'),
            confirmPin: document.getElementById('confirmPin'),
            matchError: document.getElementById('matchError'),
            submitBtn: document.getElementById('submitBtn'),
            btnText: document.getElementById('btnText'),
            btnLoader: document.getElementById('btnLoader')
        };

        // 1. Verifikasi Kode saat halaman dimuat
        if (!actionCode) {
            showState('error'); // Tidak ada kode di URL
        } else {
            verifyPasswordResetCode(auth, actionCode)
                .then((email) => {
                    // Kode valid, tampilkan form
                    showState('form');
                })
                .catch((error) => {
                    // Kode tidak valid/expired
                    showState('error');
                    console.error(error);
                });
        }

        // 2. Handle Submit PIN Baru
        document.getElementById('newPinForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const pin = els.newPin.value;
            const confirm = els.confirmPin.value;

            if (pin.length !== 6) return alert("PIN harus 6 digit.");
            if (pin !== confirm) {
                els.matchError.classList.remove('hidden');
                return;
            }
            els.matchError.classList.add('hidden');

            // Proses Reset
            setLoading(true);
            confirmPasswordReset(auth, actionCode, pin)
                .then(() => {
                    setLoading(false);
                    showState('success');
                    setTimeout(() => { window.location.href = 'index.html'; }, 3000);
                })
                .catch((error) => {
                    setLoading(false);
                    alert("Gagal mereset: " + error.message);
                });
        });

        // Helper Functions
        function showState(stateName) {
            ['verifying', 'form', 'error', 'success'].forEach(id => {
                document.getElementById(id+'State').classList.add('hidden');
            });
            if(stateName === 'verifying') els.verifying.classList.remove('hidden');
            if(stateName === 'form') { els.verifying.classList.add('hidden'); els.form.classList.remove('hidden'); }
            if(stateName === 'error') { els.verifying.classList.add('hidden'); els.error.classList.remove('hidden'); }
            if(stateName === 'success') { els.form.classList.add('hidden'); els.success.classList.remove('hidden'); }
        }

        function setLoading(isLoading) {
            els.submitBtn.disabled = isLoading;
            if(isLoading) { els.btnText.classList.add('hidden'); els.btnLoader.classList.remove('hidden'); }
            else { els.btnText.classList.remove('hidden'); els.btnLoader.classList.add('hidden'); }
        }

        // Input Constraints (Hanya Angka)
        [els.newPin, els.confirmPin].forEach(el => {
            el.addEventListener('input', function() { this.value = this.value.replace(/[^0-9]/g, ''); });
        });

        // Toggle Password Visibility
        function setupToggle(btnId, inputId) {
            document.getElementById(btnId).addEventListener('click', function() {
                const input = document.getElementById(inputId);
                const icon = this.querySelector('i');
                if (input.type === 'password') { input.type = 'text'; }
                else { input.type = 'password'; }
            });
        }
        setupToggle('toggleNew', 'newPin');
        setupToggle('toggleConfirm', 'confirmPin');

        lucide.createIcons();
    </script>
</body>
</html>
